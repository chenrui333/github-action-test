# ref, https://stackoverflow.com/questions/71791532/github-actions-homebrew-install-terraform-version-lags-behind
name: brew

on:
  pull_request:
    branches:
      - main

env:
  # `test` and `audit` are test dev commands
  HOMEBREW_DEVELOPER: 1
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_ANALYTICS: 1
  # save some time
  HOMEBREW_NO_INSTALL_CLEANUP: 1
  # no need to upgrade dependants
  HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: 1
  # https://github.com/Homebrew/homebrew-test-bot/pull/868
  HOMEBREW_NO_INSTALL_FROM_API: 1
  # enable debug logging, https://docs.github.com/en/actions/monitoring-and-troubleshooting-workflows/enabling-debug-logging
  ACTIONS_RUNNER_DEBUG: true
  ACTIONS_STEP_DEBUG: true

# three jobs in this workflow:
# 1. check formula
# 2. debug formula on macos (runs on PR only)
# 3. debug formula on ubuntu (runs on PR only)
jobs:
  # # check formula
  # formula-check:
  #   runs-on: ubuntu-22.04
  #   steps:
  #     - uses: actions/checkout@v3

  #     # As brew got removed from the ubuntu-latest image, we need to install it
  #     # https://github.com/actions/runner-images/issues/6283
  #     - name: Set up Homebrew
  #       id: set-up-homebrew
  #       # https://github.com/Homebrew/actions/tree/master/setup-homebrew
  #       uses: Homebrew/actions/setup-homebrew@bc738ca370c95ed8d8b44c9b5fcba16e54f5218a

  #     - run: brew update

  #     - name: Install tf and tg
  #       run: brew install terraform && brew install terragrunt

  #     - name: check versions
  #       run: |
  #         terraform --version
  #         terragrunt --version

  # # debug formula on macos
  formula-debug-macos13-trino:
    runs-on: macos-13
    if: github.event_name == 'pull_request'
    steps:
      - run: brew update
      - name: Install/test trino
        run: |
          brew install trino
          brew test trino

  # # debug formula on ubuntu
  formula-debug-ubuntu-kafka:
    runs-on: ubuntu-22.04
    if: github.event_name == 'pull_request'
    steps:
      # As brew got removed from the ubuntu-latest image, we need to install it
      # https://github.com/actions/runner-images/issues/6283
      - name: Set up Homebrew
        id: set-up-homebrew
        # https://github.com/Homebrew/actions/tree/master/setup-homebrew
        uses: Homebrew/actions/setup-homebrew@bc738ca370c95ed8d8b44c9b5fcba16e54f5218a
      - run: brew update
      - name: Install/test kafka
        run: |
          brew install kafka
          brew test kafka
  formula-debug-ubuntu-monero:
    runs-on: ubuntu-22.04
    if: github.event_name == 'pull_request'
    steps:
      # As brew got removed from the ubuntu-latest image, we need to install it
      # https://github.com/actions/runner-images/issues/6283
      - name: Set up Homebrew
        id: set-up-homebrew
        # https://github.com/Homebrew/actions/tree/master/setup-homebrew
        uses: Homebrew/actions/setup-homebrew@bc738ca370c95ed8d8b44c9b5fcba16e54f5218a
      - run: brew update
      - name: Install/test monero
        run: |
          brew install monero
          brew test monero
  formula-debug-ubuntu-questdb:
    runs-on: ubuntu-22.04
    if: github.event_name == 'pull_request'
    steps:
      # As brew got removed from the ubuntu-latest image, we need to install it
      # https://github.com/actions/runner-images/issues/6283
      - name: Set up Homebrew
        id: set-up-homebrew
        # https://github.com/Homebrew/actions/tree/master/setup-homebrew
        uses: Homebrew/actions/setup-homebrew@bc738ca370c95ed8d8b44c9b5fcba16e54f5218a
      - run: brew update
      - name: Install/test questdb
        run: |
          brew install questdb
          brew test questdb
  formula-debug-ubuntu-solr:
    runs-on: ubuntu-22.04
    if: github.event_name == 'pull_request'
    steps:
      # As brew got removed from the ubuntu-latest image, we need to install it
      # https://github.com/actions/runner-images/issues/6283
      - name: Set up Homebrew
        id: set-up-homebrew
        # https://github.com/Homebrew/actions/tree/master/setup-homebrew
        uses: Homebrew/actions/setup-homebrew@bc738ca370c95ed8d8b44c9b5fcba16e54f5218a
      - name: Install/test solr
        run: |
          brew install solr
          brew test solr
  formula-debug-ubuntu-sonarqube:
    runs-on: ubuntu-22.04
    if: github.event_name == 'pull_request'
    steps:
      # As brew got removed from the ubuntu-latest image, we need to install it
      # https://github.com/actions/runner-images/issues/6283
      - name: Set up Homebrew
        id: set-up-homebrew
        # https://github.com/Homebrew/actions/tree/master/setup-homebrew
        uses: Homebrew/actions/setup-homebrew@bc738ca370c95ed8d8b44c9b5fcba16e54f5218a
      - name: Install/test sonarqube
        run: |
          brew install sonarqube
          brew test sonarqube
